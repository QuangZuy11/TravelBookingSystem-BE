@startuml Traveler Book Tour - Sequence Diagram

skinparam sequenceMessageAlign center
skinparam lifelinestrategy solid

actor Traveler as user
participant "Frontend\n(BookTourDetail)" as frontend
participant "Auth Middleware" as auth
participant "TourBookingController" as bookingCtrl
participant "TourPaymentController" as paymentCtrl
participant "TourBookingService" as bookingSvc
participant "TourPaymentService" as paymentSvc
participant "Tour Model" as tourModel
participant "TourBooking Model" as bookingModel
participant "TourPayment Model" as paymentModel
participant "Promotion Model" as promoModel
participant "PayOS Service" as payos
database "MongoDB" as db
participant "Email Service" as emailSvc
participant "Notification Service" as notifSvc

== 1. User Fills Booking Form ==

user -> frontend: Fill booking form\n(tour_id, date, guests, contact info)
activate frontend

== 2. Create Tour Booking ==

user -> frontend: Click "Đặt tour" button
frontend -> frontend: validateForm()
activate frontend

alt Validation fails
    frontend -> user: Show validation errors
    deactivate frontend
else Validation success
    frontend -> bookingCtrl: POST /api/traveler/tour-bookings/reserve\n{ tour_id, tour_date, guests, ... }
    activate bookingCtrl
    
    bookingCtrl -> auth: authenticateUser()
    activate auth
    auth -> auth: Verify JWT token
    auth -> bookingCtrl: req.user (authenticated)
    deactivate auth
    
    bookingCtrl -> bookingCtrl: Validate input data
    activate bookingCtrl
    
    bookingCtrl -> tourModel: findById(tour_id)
    activate tourModel
    tourModel -> db: Query Tour
    db --> tourModel: Tour data
    tourModel --> bookingCtrl: Tour object
    deactivate tourModel
    
    alt Tour not found
        bookingCtrl --> frontend: 404 - Tour not found
        deactivate bookingCtrl
    else Tour found
        bookingCtrl -> bookingCtrl: Check capacity\n(guests <= max_participants)
        bookingCtrl -> bookingCtrl: Validate tour_date\n(date >= today)
        
        bookingCtrl -> promoModel: findActivePromotions(tour_id)
        activate promoModel
        promoModel -> db: Query Promotions
        db --> promoModel: Active promotions
        promoModel --> bookingCtrl: Promotions array
        deactivate promoModel
        
        bookingCtrl -> bookingCtrl: Calculate price\n(originalPrice - discount)
        
        bookingCtrl -> bookingModel: generateBookingNumber()
        activate bookingModel
        bookingModel --> bookingCtrl: booking_number
        deactivate bookingModel
        
        bookingCtrl -> bookingModel: new TourBooking({...})
        activate bookingModel
        bookingModel -> db: Save TourBooking\n(status: "pending")
        db --> bookingModel: Booking saved
        bookingModel --> bookingCtrl: TourBooking object
        deactivate bookingModel
        
        bookingCtrl -> bookingModel: populate(tour_id, customer_id)
        activate bookingModel
        bookingModel --> bookingCtrl: Booking with populated data
        deactivate bookingModel
        
        bookingCtrl --> frontend: 201 - Booking created\n{ bookingId, bookingNumber, ... }
        deactivate bookingCtrl
        
        frontend -> frontend: setBookingCreated(data)
        deactivate frontend
    end
end

== 3. Create Payment Link ==

frontend -> paymentCtrl: POST /api/traveler/tour-payments/create\n{ booking_id }
activate paymentCtrl

paymentCtrl -> auth: authenticateUser()
activate auth
auth -> paymentCtrl: req.user
deactivate auth

paymentCtrl -> bookingModel: findById(booking_id)
activate bookingModel
bookingModel -> db: Query TourBooking
db --> bookingModel: Booking data
bookingModel --> paymentCtrl: TourBooking
deactivate bookingModel

paymentCtrl -> paymentCtrl: Check permission\n(customer_id === userId)
paymentCtrl -> paymentCtrl: Check booking status\n(status === "pending")

paymentCtrl -> paymentModel: findOne({ booking_id })
activate paymentModel
paymentModel -> db: Query TourPayment
db --> paymentModel: Existing payment (if any)
paymentModel --> paymentCtrl: Payment or null
deactivate paymentModel

alt Payment already exists and completed
    paymentCtrl --> frontend: 400 - Already paid
    deactivate paymentCtrl
else No payment or payment pending
    paymentCtrl -> paymentSvc: createTourPaymentLink(\nbookingId, amount, description, buyerInfo)
    activate paymentSvc
    
    paymentSvc -> payos: createPaymentLink(orderCode, amount, ...)
    activate payos
    payos -> payos: Generate QR code
    payos --> paymentSvc: { checkoutUrl, qrCode, orderCode, ... }
    deactivate payos
    
    paymentSvc --> paymentCtrl: Payment link data
    deactivate paymentSvc
    
    paymentCtrl -> paymentModel: new TourPayment({...})
    activate paymentModel
    paymentModel -> db: Save TourPayment\n(status: "pending")
    db --> paymentModel: Payment saved
    paymentModel --> paymentCtrl: TourPayment object
    deactivate paymentModel
    
    paymentCtrl -> paymentCtrl: Convert QR to base64 image
    paymentCtrl --> frontend: 201 - Payment created\n{ payment_id, qr_code_base64, checkout_url, ... }
    deactivate paymentCtrl
    
    frontend -> frontend: setPaymentData(data)
    frontend -> frontend: setShowPaymentModal(true)
    frontend -> frontend: startPaymentStatusPolling(payment_id)
end

== 4. Display Payment QR Code ==

frontend -> user: Show payment modal\nwith QR code
activate frontend
deactivate frontend

== 5. Poll Payment Status (Every 3 seconds) ==

loop Every 3 seconds (max 2 minutes)
    frontend -> paymentCtrl: GET /api/traveler/tour-payments/:paymentId/status
    activate paymentCtrl
    
    paymentCtrl -> paymentModel: findById(paymentId)
    activate paymentModel
    paymentModel -> db: Query TourPayment
    db --> paymentModel: Payment data
    paymentModel --> paymentCtrl: TourPayment
    deactivate paymentModel
    
    alt Payment status is "completed" or "failed"
        paymentCtrl --> frontend: { status: "completed"/"failed" }
        deactivate paymentCtrl
    else Payment status is "pending"
        paymentCtrl -> paymentSvc: getTourPaymentInfo(orderCode)
        activate paymentSvc
        
        paymentSvc -> payos: getPaymentInfo(orderCode)
        activate payos
        payos --> paymentSvc: Payment status from PayOS
        deactivate payos
        
        paymentSvc --> paymentCtrl: Payment info
        deactivate paymentSvc
        
        alt PayOS status is "PAID"
            paymentCtrl -> paymentModel: update status to "completed"
            activate paymentModel
            paymentModel -> db: Update TourPayment\n(status: "completed", paid_at: now)
            db --> paymentModel: Updated
            paymentModel --> paymentCtrl: Updated payment
            deactivate paymentModel
            
            paymentCtrl -> bookingModel: findByIdAndUpdate(booking_id)
            activate bookingModel
            bookingModel -> db: Update TourBooking\n(status: "paid", payment.status: "completed")
            db --> bookingModel: Updated
            bookingModel --> paymentCtrl: Updated booking
            deactivate bookingModel
            
            paymentCtrl -> emailSvc: sendTourBookingConfirmationEmail()
            activate emailSvc
            emailSvc -> emailSvc: Prepare email content
            emailSvc -> emailSvc: Send email (SMTP)
            emailSvc --> paymentCtrl: Email sent
            deactivate emailSvc
            
            paymentCtrl -> notifSvc: createBookingSuccessNotification()
            activate notifSvc
            notifSvc -> db: Save notification
            db --> notifSvc: Notification saved
            notifSvc --> paymentCtrl: Success
            deactivate notifSvc
            
            paymentCtrl --> frontend: { status: "completed", ... }
            deactivate paymentCtrl
            
            frontend -> frontend: clearInterval(pollInterval)
            frontend -> user: Alert "✅ Thanh toán thành công!"
            frontend -> frontend: window.location.reload()
        else PayOS status is "PENDING"
            paymentCtrl --> frontend: { status: "pending", qr_code_base64, ... }
            deactivate paymentCtrl
        end
    end
end

== 6. Payment Success ==

user -> user: Scan QR code\nand complete payment
activate user
deactivate user

note right of payos
    User pays via PayOS
    PayOS updates payment status
end note

== 7. Optional: Cancel Payment ==

alt User cancels payment
    user -> frontend: Click "Hủy" button
    frontend -> paymentCtrl: POST /api/traveler/tour-payments/:paymentId/cancel
    activate paymentCtrl
    
    paymentCtrl -> paymentSvc: cancelTourPayment(orderCode)
    activate paymentSvc
    paymentSvc -> payos: cancelPayment(orderCode)
    activate payos
    payos --> paymentSvc: Cancelled
    deactivate payos
    paymentSvc --> paymentCtrl: Success
    deactivate paymentSvc
    
    paymentCtrl -> paymentModel: update status to "cancelled"
    activate paymentModel
    paymentModel -> db: Update TourPayment
    paymentModel --> paymentCtrl: Updated
    deactivate paymentModel
    
    paymentCtrl --> frontend: 200 - Payment cancelled
    deactivate paymentCtrl
    
    frontend -> bookingCtrl: POST /api/traveler/tour-bookings/:bookingId/cancel
    activate bookingCtrl
    bookingCtrl -> bookingModel: update status to "cancelled"
    activate bookingModel
    bookingModel -> db: Update TourBooking
    bookingModel --> bookingCtrl: Updated
    deactivate bookingModel
    
    bookingCtrl -> notifSvc: createBookingCancellationNotification()
    activate notifSvc
    notifSvc -> db: Save notification
    notifSvc --> bookingCtrl: Success
    deactivate notifSvc
    
    bookingCtrl --> frontend: 200 - Booking cancelled
    deactivate bookingCtrl
    
    frontend -> frontend: Close payment modal
    frontend -> user: Show cancellation message
end

@enduml

